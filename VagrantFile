systems = [
     {
          :name => "workstation",
          :type => "workstation",
          :role => "workstation",
          :box  =>  "ubuntu/xenial64",
          :box_version => "20180831.0.0",
          :eth1 => "10.1.1.100",
          :mem => "4096",
          :cpu => "4"
     },
     {
          :name => "ns0",
          :type => "server",
          :role => "DNS",
          :box  =>  "ubuntu/xenial64",
          :box_version => "20180831.0.0",
          :eth1 => "10.1.1.10",
          :mem => "4096",
          :cpu => "4"
     }     
]

Vagrant.configure("2") do |config|
     systems.each do |opts|
          config.vm.define opts[:name] do |config|
               
               # Create Workstation and System Settings
               config.vm.box = opts[:box]
               config.vm.box_version = opts[:box_version]
               config.vm.hostname = opts[:name]
               config.vm.network :private_network, ip: opts[:eth1]

               config.vm.provider "virtualbox" do |v|
                    v.name = opts[:name]
                    v.customize ["modifyvm", :id, "--memory", opts[:mem]]
                    v.customize ["modifyvm", :id, "--cpus", opts[:cpu]]
               end

               #Configure Systems
               if opts[:type] == "workstation"
                    # If this is a workstation then we install all sorts of fun stuff
                    config.vm.provision "shell", path: "ubuntu/dockerInstall.sh"
                    config.vm.provision "shell", path: "ubuntu/basics.sh"
                    config.vm.provision "shell", path: "ubuntu/hashistackInstall.sh"
                    config.vm.provision "shell", path: "ubuntu/awsCLI.sh"

                    # If there are local SSH Keys, mount the directory 
                    if ENV['VAGRANT_SSH_KEY_LOCATION']
                         config.vm.provision "file", source: ENV['VAGRANT_SSH_KEY_LOCATION'], destination: "/home/vagrant/.ssh"
                         config.vm.provision "shell", inline: "echo \"# Modify the .ssh contents so only vagrant can access\" >> .bashrc"
                         config.vm.provision "shell", inline: "echo \"chmod 400 /home/vagrant/.ssh/* || true\" >> .bashrc"                         
                    end
                    
                    # If there code to share with the workstation, mount the code directory
                    if ENV['VAGRANT_LOCAL_MOUNT']
                         config.vm.synced_folder ENV['VAGRANT_LOCAL_MOUNT'], "/home/vagrant/code"
                    end
               end
          end
     end
end 